#!/bin/bash
# vim: ft=config ts=2 sw=2 sts=2 et

# vpm - void package management utility for

# XBPS, the X Binary Package System
# Copyright (c) 2016 Armin Jenewein <a@m2m.pm>

getversion () {
  cd "${0%/*}"
  git describe --all --debug --long --tags 2>/dev/null || echo "UNKNOWN"
}

version="$(getversion)"

# set to "false" to permanently disable colors
# NOTE: you can also set $VPM_COLOR_DISABLE in your
# environment to completely turn colorization off (for use in scripts)
if [[ "$VPM_COLOR_DISABLE" ]]; then
  color=false
else
  color=true
fi

# check for --color
case "$1" in
  "--color=false")
  color=false
  shift
  ;;
  "--color=true")
	  color=true
  shift
  ;;
esac

# colorize stuff
color () {
if [[ $color == true ]]; then
  case "$1" in
    [0-9]*)
      tput setaf "$1"
    ;;
    reset)
      tput sgr0
    ;;
    *)
      tput "$@"
    ;;
  esac
fi
}

# print a message
msg () {
  color 110
  echo -n "["
  color 214
  echo -n "vpm"
  color 110
  echo -n "] "
  echo "$@"
  color sgr0
}

# print vpm banner
banner () {
  cat <<EOF
 __ ___ __ _ __  
 \ V / '_ \ '  \   vpm - void package management utility
  \_/| .__/_|_|_|  GitHub: https://github.com/netzverweigerer/vpm
     |/         
EOF
}

# print version information
version () {
  color 107
  echo
  banner
  color sgr0
  msg "vpm - Version: $version"
  msg "Copyright (c) 2016 Armin Jenewein <a@m2m.pm>"
  msg "XBPS version: $(xbps-query --version)"
}

# extract versionstring appendix from given package name
extract_versionstring () {
  echo "$1" | rev | cut -d"-" -f 1 | rev
}

# extract versionstring appendix from given package name
extract_packagename () {
  echo "$1" | rev | cut -d"-" -f 2- | rev
}

usage () {
  version
  color 66
  echo
  echo "USAGE: "
  color 101
  echo
  echo "vpm [OPTIONS] [SUBCMD] [<OPTIONS>] [<args>]"
  echo 
  color 66
  echo
  echo "OPTIONS: "
  color 101
  echo
  echo "--color=<true/false>         - Enable/Disable colorized output"
  echo "--help                       - (same as: help)"
  echo
  color 66
  echo
  echo -n "SUBCOMMANDS: "
  echo "(feel free to prefix them with --, vpm doesn't care.)"
  echo
  color 109
  echo "sync                         - Synchronize remote repository data"
  echo "update                       - Update the system"
  echo "repolist                     - List configured repositories"
  echo "listrepos                    - (same as: repolist)"
  echo "addrepo                      - Add an additional repository"
  echo "info <package>               - Show information about <package>"
  echo "filelist <package>           - Show file-list of <package>"
  echo "dependencies <package>       - Show dependendies of <package>"
  echo "reverse <package>            - Show reverse dependendies of <package>"
  echo "search <name>                - Search for package by <name>"
  echo "searchfile <file>            - Search for package containing <file>"
  echo "list                         - List installed packages"
  echo "install <package>            - Install <package>"
  echo "forceinstall <package>       - Force installation of <package>"
  echo "remove <package)             - Remove <package>"
  echo "cleanup                      - Clean up cache directory"
  echo "autoremove                   - Remove orphaned packages"
  echo "help                         - Show usage information"
  echo
  color 66
  echo
  echo "XBPS COMPATIBILITY:"
  color 103
  f=(/usr/sbin/xbps-*)
  echo
  echo "vpm also understands xbps commands:"
  echo -n "Example: "
  selected=${f[$RANDOM % ${#f[@]}]}
  echo "${0##*/} ${selected##*-} <ARGS>"
  echo
  echo
}


if [[ "$1" == "" ]]; then
  usage
  exit 0
fi

arg="$1"

if [[ "$arg" =~ --.* ]]; then
b="${arg:2}"
arg="$b"
fi

case "$arg" in
  info)
    shift
    msg "(xbps-query -R $@):"
    xbps-query -R "$@"
    ret=$?; msg "Execution finished (xbps-query -R $@), return code was: $ret"
    exit $ret
  ;;

  filelist)
    shift
    xbps-query -R -f "$@"
    ret=$?; msg "Execution finished (xbps-query -R -f \"*/$1\"), return code was: $ret"
    exit $ret
  ;;

  dependencies)
    shift
    xbps-query -R -x "$@"
    ret=$?; msg "Execution finished (xbps-query -R -x \"*/$1\"), return code was: $ret"
    exit $ret
  ;;

  reverse)
    shift
    msg "Reverse dependencies for $@ (xbps-query -R $@):"
    xbps-query -R -X "$@"
    ret=$?; msg "Execution finished (xbps-query -R $@), return code was: $ret"
    exit $ret
  ;;

  searchfile)
    shift
    msg "searchfile: This might take a long time, please be patient..."
    msg "(xbps-query -R -o \"*/$1\"):"
    sleep 1
    xbps-query -R -o "*/$1"
    ret=$?; msg "Execution finished (xbps-query -R -o \"*/$1\"), return code was: $ret"
    exit $ret
  ;;

  list)
    shift
    msg "Installed packages: "
    count=0
    xbps-query -l | while read line; do
    let count=count+1
    pkgname="$(echo "$line" | cut -d" " -f 2 | xargs -0)"
    version="$(extract_versionstring "$pkgname")"
    pkg="$(extract_packagename "$pkgname")"
    tput setaf 32
    echo -e -n "($count) ${pkg} "
    tput setaf 244
    echo -e -n " [${version}] "
    tput setaf 241
    echo " [${pkgname}] "
    shift
    done
  ;;

  repolist|listrepos)
    msg "Configured repositories (xbps-query -L): "
    xbps-query -L
    shift
    echo
    msg "Available sub-repositories (xbps-query -Rs void-repo): "
    xbps-query -Rs void-repo
    msg "[xbps-query -Rs void-repo] return code: $?"
    shift
    echo
    msg "Use \"vpm addrepo <repository>\" to add a sub-repository."
    echo
  ;;

  addrepo)
    shift
    while [ "$#" -gt 0 ]; do
    msg "Adding repository: $1"
    xbps-install "$1"
    msg "[xbps-install $arg] return code: $?"
    shift
    done
    ;;
  sync)
    msg "Synchronizing remote repository data: (xbps-install -S):"
    xbps-install -S
    msg "[xbps-install -S] return code: $?"
  ;;

  install)
  shift
  if [ "$#" -lt 1 ]; then
    msg "ERROR: install: argument missing"
    usage
    exit 1
  fi
  args=($@)
  count=0
  msg "Packages will be installed one-by-one"
  msg "Use \"forceinstall\" to override this if you know what you're doing."
  for arg in "${args[@]}"; do
  let count=count+1
  msg "Installing packages: ($count/${#args[@]}): $arg (xbps-install -S $arg) ..."
  xbps-install -S "$arg"
  ret="$?"
  msg "[xbps-install -S $arg] return code: $ret"
  done
  ;;

  forceinstall)
  shift
  msg "Force-Installing Package(s): $@ (xbps-install -Sf $@)"
  xbps-install -Sf "$@"
  ;;

  remove)
  shift
  msg "Removing package(s): $@ (xbps-remove $@)"
  xbps-remove "$@"
  ;;

  autoremove)
  shift
  msg "autoremove: Removing orphaned packages (xbps-remove -Q)"
  xbps-remove -O
  msg "done."
  ;;

  update)
  shift
  msg "Running system update (xbps-install -Sduv)"
  xbps-install -Suv
  msg "[xbps-install -Suv] return code: $?"
  ;;

  search)
  shift
  msg "Searching for: $@ (xbps-query -Rs $@)"
  xbps-query -Rs "$@"
  msg "[xbps-query -Rs $@] return code: $?"
  ;;

  cleanup)
  msg "Cleaning up packages (will remove orphaned packages) (xbps-remove -O $@)"
  shift
  xbps-remove -O "$@"
  msg "[xbps-remove --D $@] return code: $?"
  ;;

  help|-h|--help)
  usage
  ;;

  ''|*)
  a="$1"
  if hash "xbps-${a}" >/dev/null 2>&1; then
    shift
    # xbps-<subcommand> found
    msg "relaying to XBPS: xbps-${a} $@"
    xbps-${a} $@
  else
    msg "Unrecognized vpm subcommand: $1 (and xbps-$1 does not exist) - Try: ${0##*/} help"
    echo
    exit 1
  fi
  ;;

esac

exit 0

