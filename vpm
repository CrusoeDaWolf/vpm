#!/bin/bash
# vim: ft=config ts=2 sw=2 sts=2 et

# vpm - void package management utility for

# XBPS, the X Binary Package System
# Copyright (c) 2016 Armin Jenewein <a@m2m.pm>

getversion () {
  cd "${0%/*}"
  git describe --all --debug --long --tags 2>/dev/null || echo "UNKNOWN"
}

version="$(getversion)"

# set to "true" to enable colorized output, or "auto" to use auto-detection via $TERM
color=auto

# enable auto colorization
autocolor () {
  case "$TERM" in
    *256*color*)
    color=true
    ;;
  esac
}

# verbose mode
verbose=false

case "$1" in
  --color=true|--color=yes|--color=on)
	  color=true
    shift
  ;;
  --color=auto)
    autocolor
    shift
  ;;
  --color=false|--color=off|--color=no)
    color=false
    shift
  ;;
  --verbose=true)
    shift
    verbose=true
  ;;
  --show-translations)
    shift
    show_translations=1
  ;;
esac

color () {
if [[ ! $color == "false" ]]; then
  case "$1" in
    [0-9]*)
      tput setaf "$1"
    ;;
    reset)
      tput sgr0
    ;;
    *)
      tput "$@"
    ;;
  esac
fi

}

msg () {
  color 243
  echo -n "["
  color 38
  echo -n "vpm"
  color 243
  echo -n "] "
  color 245
  echo "$@"
  color sgr0
}

if [[ "$UID" -gt 0 ]]; then
  msg "ERROR: ${0##*/} needs super-user privileges. Exiting."
  exit 255
fi


banner () {
  banner_fg=102
  banner_bg=66
  color $banner_fg
  echo  ' __ ___ __ _ __  '
  echo -n " \ V / '_ \ '  \ "
  color $banner_bg
  echo '  vpm - void package management utility for XBPS'
  color $banner_fg
  echo -n '  \_/| .__/_|_|_|'
  color $banner_bg
  echo '  GitHub: https://github.com/netzverweigerer/vpm'
  color $banner_fg
  echo '     |/          '
  echo '     Â´          '
  color reset
}

version () {
  color 107
  banner
  color sgr0
  msg "vpm - Version: $version"
  msg "Copyright (c) 2016 Armin Jenewein <a@m2m.pm>"
  msg "XBPS version: $(xbps-query -v --version)"
}

# extract versionstring appendix from given package name
extract_versionstring () {
  echo "$1" | rev | cut -d"-" -f 1 | rev
}

# extract versionstring appendix from given package name
extract_packagename () {
  echo "$1" | rev | cut -d"-" -f 2- | rev
}

t () {
if [[ "$show_translations" != "" ]]; then
tput setaf 242
echo "                             $@"
echo
tput setaf 109
fi
}

usage () {
  echo
  version
  echo
  color 66
  echo "USAGE: "
  color 247
  echo "vpm [OPTIONS] [SUBCMD] [<OPTIONS>] [<args>]"
  echo 
  color 66
  echo "OPTIONS: "
  color 247
  echo "--color=<yes|no|auto>        - Enable/Disable colorized output (default: auto)"
  echo "--help                       - (same as: help)"
  echo "--help-pager                 - (same as: helppager)"
  echo "--show-translations          - Show XBPS command translations for vpm sub-commands"
  echo "--verbose                    - Verbose mode (shows XBPS command translations during execution)"
  echo
  color 66
  echo "SUBCOMMANDS: "
  color 247
  echo "sync                         - Synchronize remote repository data"
  t "xbps-install -S"
  echo "update                       - Update the system"
  t "xbps-install -Sduv"
  echo "listrepos                    - List configured repositories"
  echo "repolist                     - Alias for listrepos"
  t "xbps-query -v -L"
  echo "addrepo <args>               - Add an additional repository"
  t "xbps-install <args>"
  echo "info <package>               - Show information about <package>"
  t "xbps-query-v -R"
  echo "filelist <package>           - Show file-list of <package>"
  t "xbps-query -v -R -f"
  echo "deps <package>               - Show dependendies of <package>"
  t "xbps-query -v -R -x"
  echo "reverse <package>            - Show reverse dependendies of <package>"
  t "xbps-query -v -R -X"
  echo "search <name>                - Search for package by <name>"
  t "xbps-query -v -Rs"
  echo "searchfile <file>            - Search for package containing <file> (local)"
  t "xbps-query -v -o \"*/$1\""
  echo "list                         - List installed packages"
  t "xbps-query -v -l"
  echo "install <package(s)>         - Install <package(s)>"
  t "xbps-install -S"
  echo "devinstall <package(s)>      - Install <package> (and corresponding <package>-devel package(s))"
  t "xbps-install -S <package> <package>-devel"
  echo "listalternatives             - List alternative candidates"
  t "xbps-alternatives -l"
  echo "setalternative <package>     - Set alternative for <package>"
  t "xbps-alternatives -s"
  echo "reconfigure <package>        - Re-configure installed <package>"
  t "xbps-reconfigure -v"
  echo "forceinstall <package(s)>    - Force installation of <package(s)>"
  t "xbps-install -f"
  echo "remove <package(s))          - Remove <package(s)> from the system"
  t "xbps-remove -v "
  echo "removerecursive <package(s)> - Recursively remove package(s) (and its dependencies)"
  t "xbps-remove -v -R"
  echo "cleanup                      - Clean up cache directory"
  t "xbps-remove -v -O"
  echo "autoremove                   - Remove orphaned packages"
  t "xbps-remove -v -O"
  echo "help                         - Show usage information"
  echo "helppager                    - Show usage information (will pipe output to less/more)"
  echo
  color 66
  echo "XBPS COMPATIBILITY COOLNESS:"
  color 247
  f=(/usr/sbin/xbps-*)
  echo "vpm also understands all unknown XBPS sub-commands, too:"
  echo -n "Example: "
  selected=${f[$RANDOM % ${#f[@]}]}
  echo "${0##*/} ${selected##*-} <ARGS> - see also: /usr/sbin/xbps-*"
  echo 
  color reset
}


if [[ "$1" == "" ]]; then
  usage
  exit 0
fi

arg="$1"

if [[ "$arg" =~ --.* ]]; then
b="${arg:2}"
arg="$b"
fi

case "$arg" in
  info)
    shift
    msg "(xbps-query -v -R $@):"
    xbps-query -v -R "$@"
    ret=$?; msg "Execution finished (xbps-query -v -R $@), return code was: $ret"
    exit $ret
  ;;

  filelist)
    shift
    xbps-query -v -R -f "$@"
    ret=$?; 
    if [[ $verbose == "true" ]]; then
      msg "Execution finished (xbps-query -v -R -f \"*/$1\"), return code was: $ret"
    fi
    exit $ret
  ;;

  deps|dependencies)
    shift
    xbps-query -v -R -x "$@"
    ret=$?; msg "Execution finished (xbps-query -v -R -x \"*/$1\"), return code was: $ret"
    exit $ret
  ;;

  reverse)
    shift
    msg "Reverse dependencies for $@ (xbps-query -v -R $@):"
    xbps-query -v -R -X "$@"
    ret=$?; msg "Execution finished (xbps-query -v -R $@), return code was: $ret"
    exit $ret
  ;;

  searchfile)
    shift
    msg "searchfile (xbps-query -v -o \"*/$1\"):"
    sleep 1
    xbps-query -v -o "*/$1"
    ret=$?; msg "Execution finished (xbps-query -v -R -o \"*/$1\"), return code was: $ret"
    exit $ret
  ;;

  list)
    shift
    msg "Installed packages: "
    count=0
    xbps-query -v -l | while read line; do
    let count=count+1
    pkg="$(printf ${line#* } | xargs)"
    pkgname="$(printf '%s\n' "${pkg%-*}")"
    version="$(printf '%s\n' "${pkg##*-}")"
    color 38
    echo -n "$pkgname "
    color 241
    echo -n " ("
    color 106
    echo -n "$version"
    color 241
    echo -n ") "
    color 241
    echo -n " ["
    color 247
    echo -n "$pkg"
    color 241
    echo "]"
    color reset
    shift
    done
  ;;

  listalternative|listalternatives)
  xbps-alternatives -l "$@"
  ;;

  setalternative|setalternatives)
  shift
  xbps-alternatives -s "$@"
  ;;

  repolist|listrepos)
    msg "Configured repositories (xbps-query -v -L): "
    xbps-query -v -L
    shift
    echo
    msg "Available sub-repositories (xbps-query -v -Rs void-repo): "
    xbps-query -v -Rs void-repo
    msg "[xbps-query -v -Rs void-repo] return code: $?"
    shift
    echo
    msg "Use \"${0##*/} addrepo <repository>\" to add a sub-repository."
    echo
  ;;

  addrepo)
    shift
    while [ "$#" -gt 0 ]; do
    msg "Adding repository: $1"
    xbps-install "$1"
    msg "[xbps-install $arg] return code: $?"
    msg "Synchronizing remote repository data (xbps-install -S): "
    xbps-install -S
    msg "[xbps-install -S] return code: $?"
    shift
    done
    ;;
  sync)
    msg "Synchronizing remote repository data: (xbps-install -S):"
    xbps-install -S
    msg "[xbps-install -S] return code: $?"
  ;;

  install)
  shift
  if [ "$#" -lt 1 ]; then
    msg "ERROR: install: argument missing"
    usage
    exit 1
  fi
  args=($@)
  count=0
  msg "Packages will be installed one-by-one"
  msg "Use \"forceinstall\" to override this if you know what you're doing."
  for arg in "${args[@]}"; do
  let count=count+1
  msg "Installing packages: ($count/${#args[@]}): $arg (xbps-install -S $arg) ..."
  xbps-install -S "$arg"
  ret="$?"
  msg "[xbps-install -S $arg] return code: $ret"
  done
  ;;

  devinstall)
  shift
  if [ "$#" -lt 1 ]; then
    msg "ERROR: devinstall: argument missing"
    usage
    exit 1
  fi
  args=($@)
  msg "devinstall: Packages will be installed one-by-one"
  msg "Use \"forceinstall\" to override this if you know what you're doing."
  msg "(Note: forceinstall won't install -devel packages)"
  for arg in "${args[@]}"; do
  let count=count+1
  msg "Installing package: $arg (xbps-install -S $arg) ..."
  xbps-install -S "$arg"
  ret="$?"
  msg "[xbps-install -S $arg] return code: $ret"
  msg "installing devel package (${arg}-devel):"
  xbps-install -S "${arg}-devel"
  ret="$?"
  msg "[xbps-install -S ${arg}-devel] return code: $ret"
  done
  ;;


  forceinstall)
  shift
  msg "Force-Installing Package(s): $@ (xbps-install -Sf $@)"
  xbps-install -Sf "$@"
  ;;

  remove)
  shift
  msg "Removing package(s): $@ (xbps-remove -v $@)"
  xbps-remove -v "$@"
  ;;

  removerecursive)
  shift
  msg "Removing package(s) recursively: $@ (xbps-remove -v -R $@)"
  xbps-remove -v -R "$@"
  ;;

  reconfigure)
  shift
  msg "reconfigure: Re-configuring package(s) (xbps-reconfigure -v $@):"
  xbps-reconfigure -v "$@"
  ;; 

  autoremove)
  shift
  msg "autoremove: Removing orphaned packages (xbps-remove -v -Q)"
  xbps-remove -v -O
  msg "done."
  ;;

  update)
  shift
  msg "Running system update (xbps-install -Suv)"
  xbps-install -Suv
  msg "[xbps-install -Suv] return code: $?"
  ;;

  search)
  shift
  msg "Searching for: $@ (xbps-query -v -Rs $@)"
  xbps-query -v -Rs "$@"
  msg "[xbps-query -v -Rs $@] return code: $?"
  ;;

  cleanup)
  msg "Cleaning up packages (will remove orphaned packages) (xbps-remove -v -O $@)"
  shift
  xbps-remove -v -O "$@"
  msg "[xbps-remove -v --D $@] return code: $?"
  ;;

  help|-h|--help)
  usage
  ;;

  helppager|help-pager)
    if hash less >/dev/null 2>&1; then
      $0 --color=off help | less
    else
      $0 --color=off help | more
    fi
  ;;

  ''|*)
  a="$1"
  if hash "xbps-${a}" >/dev/null 2>&1; then
    shift
    # xbps-<subcommand> found
    msg "relaying to XBPS: xbps-${a} $@"
    xbps-${a} $@
  else
    msg "Unrecognized vpm subcommand: $1 (and xbps-$1 does not exist) - Try: ${0##*/} help"
    echo
    exit 1
  fi
  ;;

esac

exit 0


